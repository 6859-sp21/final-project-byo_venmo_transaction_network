<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title> BYO Venmo Network </title>
<link rel="shortcut icon" type="image/png" href="favicon.png"/>
<script src="https://d3js.org/d3.v6.js"></script>
<script src="graphemesplitter.js"></script>
<style type="text/css">
svg {
	display: block;
	margin: auto;
}

body {
	font-size: 15px;
	font-family: Helvetica, sans-serif;
}

@font-face {
  font-family: 'emoji';
  src: url('NotoColorEmoji.ttf')
  format('truetype');
}


h1{
	color: #3d95ce;
}

.filtering{
	display: inline-block;
	padding: 10px;
	margin-right: 20px;
}

.biggraph{
	border-style: solid;
	border-width: 1px;
}

.smallgraph{
	border-style: solid;
	display: inline-block;
	border-width: 1px;
}


div.tooltip {
	position:absolute;
	text-align: left;
	width: auto;
	height: auto;
	padding: 3px;
	font: 14px sans-serif;
	font-weight: 300;
	border: 2px;
	border-radius: 0px;
	pointer-events: none;
	background-color: #3d95ce;
}

div.tooltip_img {
	position: absolute;
	text-align: center;
	width: 50px;
	height: 50px;
	padding: 0px;
	font: 14px sans-serif;
	font-weight: 900;
	border: 0px;
	border-radius: 0px;
	pointer-events: none;
}

div.tooltip_blur {
	position: absolute;
	text-align: center;
	width: 50px;
	height: 50px;
	padding: 0px;
	font: 14px sans-serif;
	font-weight: 900;
	border: 0px;
	border-radius: 0px;
	pointer-events: none;
	background-color: #c8d5df;
}

#datesubmit{
	background-color:#3d95ce;
	margin-left: 20px;
	margin-right: 20px;
}

div.instructions {
	position:absolute;
	text-align: left;
	width: 90vw;
	height: 60vh;
	padding: 12px;
	font: 14px sans-serif;
	font-weight: 300;
	color: white;
	border: 8px;
	border-style:double;
	border-width: 2px;
	border-color: rgb(8, 4, 2);
	border-radius: 8px;
	pointer-events: none;
	background-color: #3d95ce;
	opacity: 01;
}

</style>

</head>

<body>

<h1>Build Your Own Venmo Network</h1>

<select id="d3-dropdown">
	<option value="None">Select User to Start Network</option>
	<option value="None">None</option>
	<option value="Crew-Chiefs">Crew-Chiefs [small] </option>
	<option value="BambinoTechnologiesInc">BambinoTechnologiesInc [medium] </option>
	<option value="nomad-rides-2">nomad-rides-2 [large] </option>
	<option value="blingq">blingq [extra large]</option>
</select>

<div id="begin" class="filtering">
	<input id="begin" type="button" value="Begin">
</div>
<div></div>
<div></div>
<div></div>
<div></div>
<div></div>
  
<div id="searchfilter" class="filtering">
	<label for="search">Search by Username:</label><input type="text" id="search">
</div>
<div id="msgfilter" class="filtering">
	<label for="search">Search messages:</label><input type="text" id="msg" size="10"><button>ðŸ˜€</button>
</div>
<div id="datefilter" class="filtering">
	<label for="startdate">Start date:</label><input type="date" id="startdate" value="2018-07-01" min="2018-07-01" max="2019-02-28">
	<label for="enddate">End date:</label><input type="date" id="enddate" value="2019-02-28" min="2018-07-01" max="2019-02-28">
	<input id="datesubmit" type="button" value="Search">
</div>
<div id="chargefilter" class="filtering" style="display:none">
<label for="chargeorpay">Charges, payments, or both:</label>
<select id="chargeorpay">
  <option value="all">All</option>
  <option value="charges">Charges</option>
  <option value="payments">Payments</option>
</select>
</div>
<div id="showalldiv" class="filtering">
	<input id="showall" type="button" value="Clear all users">
</div>
<div id="instr" class="filtering"><input id="instragain" type="button" value="View instructions"></div>


<div id="namesearches">
</div>

<div id="nonodesfound" style="display: none;">No users found!</div>

<div id="networkvis" class="biggraph"></div>

<div style="margin:auto;text-align: center;">
<div id="graphoverdate" class="smallgraph"></div>

<div id="graphovertime" class="smallgraph"></div>
</div>

<div style="margin:auto;text-align: center;">
<div id="usergraph" class="smallgraph"></div>

<div id="emojigraph" class="smallgraph"></div>
</div>

<script>

// Instructions to please wait during loading
var wind_width = window.innerWidth,
	wind_height = window.innerHeight;

var instructions0 = d3.select("body").append("div")
		.attr("class", "instructions")
		.style("left", (wind_width / 20) + "px")
		.style("top", "120px");
		//.style("top", (1.75 * wind_height / 10) + "px");

instructions0
		.html("Instructions <br>")
		.style('font-size','22px')
		.style('font-weight','700');
instructions0
		.append('text').text("Please Wait..."
		)
		.style('font-weight','normal')
		.style('font-size','14px');

Promise.all([
//d3.csv("placeholder.csv")
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-byo_venmo_transaction_network/main/venmo_eightormore_full.json"),
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-byo_venmo_transaction_network/main/justemojis.json")
])
.then(function(dt){

// Disappear the preliminary instructions
instructions0.transition()
	.duration(100)
	.style("opacity",0);

venmoData = dt[0];

allemojis = dt[1];
//console.log(venmoData.links);
//console.log(venmoData.nodes);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Some variables
var radius = 4,
	link_strength = 0.1,
	center_strength = 1,
	charge = -0.1,
	image_left = 100
	image_top = 100;

//create network
var networkW = "90vw";
var networkH = "80vh";
var networksvg = d3.select("#networkvis")
	        .append("svg")
			.attr("id", "networkvis_inner")
	        .attr("width", networkW)
	        .attr("height", networkH);


//zoom/pan functionality
var g = networksvg.append("g")
    .attr("class", "everything");

var zoom_handler = d3.zoom()
    .on("zoom", zoom_actions)
    .scaleExtent([0.5,8]);

zoom_handler(networksvg);  

function zoom_actions({transform}){
    g.attr("transform", transform);
}

// Tooltip for hovering over nodes
var node_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

// Tooltip for hovering over edges
var link_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

var img_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip_img")
               .style("opacity", 0);

// This will go directly on top of the image for privacy purposes
var blur_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip_blur")
               .style("opacity", 0);

// log scale for calculating edge width (may have to adjust the upper bound later)
var stroke_scale = d3.scaleLog().domain([1,102]).range([2,8]);

//color scale: need to add legend at some point
var color_scale = d3.scaleDiverging(d3.interpolateInferno).domain([1,3,25]); //definitely adjust bounds for more data


var link = 0, node = 0;

// There's probably a better way of locating the center of the network...
var width = networksvg.attr("width"),
	height = networksvg.attr("height"),
	wind_width = window.innerWidth,
	svg_width = d3.select('#networkvis_inner').attr('width').slice(0,2)/100,
	svg_width_px = wind_width * svg_width,
	wind_height = window.innerHeight,
	svg_height = d3.select('#networkvis_inner').attr('height').slice(0,2)/100,
	svg_height_px = wind_height * svg_height;

// Instructions...Self explanatory
var instructions = d3.select("body").append("div")
		.attr("class", "instructions")
		.style("left", (wind_width / 20) + "px")
		.style("top", "120px");
		//.style("top", (1.75 * wind_height / 10) + "px");

instructions
		.html("Instructions <br>")
		.style('font-size','22px')
		.style('font-weight','700');
instructions
		.append('text').text("Welcome to our Interactive Data Visualization where you can explore the network of publicly available " +
		"Venmo transactions between July 2018 & February 2019. All data was scraped from the public Venmo API by Dan Salmon." +
		"To begin, select a starting user from the dropdown menu (or we'll select one for you) and press the begin button to display that user and their immediate neighbors. " +
		"Hover over the nodes (users) and edges (transactions) to see details. Click on colored nodes to add their neighbors to the network or drag them around the page for easier viewing." +
		"You can also add to your network by using either of the search bars to add individual users or by message content." +
		"And don't forget to check out the plots at the bottom for more details on the network you've built." +
		"If you're in the middle of building your network, click the Begin button to close the instructions and pick up where you left off." +
		"While you're exploring, take some time to consider the data you've sent publicly over Venmo." +
		"You may or may not be in this small subset of the data, but would you want a stranger viewing your transaction history as part of their final project?"

		)
		.style('font-weight','normal')
		.style('font-size','14px');



//var namevalue = [document.getElementById("search").value];
namevalue = ["blingq"];
//namevalue = [];
click_namevalue = [];
var simulation = 0;
//var begin = false;


// Listen for the dropdown that will give the initial starting point for the network
var selected = "None";
d3.select("select")
  .on("change",function(d){
    selected = d3.select("#d3-dropdown").node().value;
    console.log( selected );
    d3.select("#selected-dropdown").text(selected);
	if (selected == "None") {
		namevalue = ["blingq"];
	} else {
		namevalue = [];
		namevalue.push(selected);
	};
});

// When the user clicks begin, the instructions will disappear and the simulation begins, woo!
document.getElementById("begin").addEventListener('click',
	function(event){
		start_sim();
		filter(event, type = "filter", start = true);
		instructions
			.transition()
			.duration(300)
			.style("opacity",0);
	});


//When View Instructions button is clicked, show instructions again
document.getElementById("instragain").addEventListener('click',
	function(){
		instructions
			.transition()
			.duration(300)
			.style("opacity",1);
	}
);

//adding some drag behavior to the nodes (drag to a fixed position)
const drag = d3
	.drag()
	.on("drag", dragged);

function dragged(event, d) {
    d.fx = clamp(event.x, 0, width);
    d.fy = clamp(event.y, 0, height);
    simulation.alpha(0.01).restart();
}

function clamp(x, lo, hi) {
  return x < lo ? lo : x > hi ? hi : x;
}


// A function that does the graph stuff
function generateGraph(nodesdata,linksdata, start = false){
	//console.log(nodesdata); console.log(linksdata);

	node_tooltip.transition()
		.duration(100)
		.style("opacity", 0);

	img_tooltip.transition()
		.duration(100)
		.style("opacity", 0);

	blur_tooltip.transition()
		.duration(100)
		.style("opacity", 0);

	//update link and node with new data
	link = g
    		.selectAll("line")
			.data(linksdata)
			.join("line")
			.style("stroke", "#aaa")
			.style("stroke-width", function(d) {
				return stroke_scale(d.weight);
			});

	node = g
		.selectAll("circle")
		.data(nodesdata)
		.join("circle")
		.attr("r", radius)
		.style("fill", function(d){return color_scale(d.neighbors.length)})
		.attr("id",d =>d.name);

	//add dragging function
	node.call(drag);
	
	// Had to paste the same mouse listeners in here. Probably a smarter way...
	node
	.on("mouseenter", function(event, d) {
		// Show the tooltip with details
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0.9);

		node_tooltip
			.html('Username: ' + d.name + '<br>' + 
			'Number of Transactions: ' + d.n_trans + '<br>' + 
			'Number of Neighbors: ' + d.neighbors.length + '<br>')
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 50) + "px")
			.style("color", "white")

		img_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		img_tooltip
			.html(' ')   
			.style("left", event.pageX + 10  + "px")
			.style("top", event.pageY + 30 + "px")
			.style("background-image", "url(" + d.photo_url + ")");
		
		// Almost immediately cover the image
		blur_tooltip.transition()
			.duration(1000)
			.ease(d3.easeCubicOut)
			.style("opacity",0.95);
		
		blur_tooltip
			.html(' ')
			.style("left", event.pageX + 10  + "px")
			.style("top", event.pageY + 30 + "px");
			
	})
	.on("mouseleave", function(event, d) {
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

		img_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
		
		blur_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

	})
	.on("click", function(event, d) {
		filter(d, "click");

		d3.select(this).transition()
		.duration(100)
		.style('opacity',0.5);
	});

	// Same for edges
	link
	.on("mouseenter", function(event, d) {
		//console.log(d);
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0.9);
		
		// Slightly different messages for edges with weight 1
		if (d.weight == 1) {
			var tooltip_text = 'User 1: ' + d.source.name + '<br>' + 
				'User 2: ' + d.target.name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Message: ' + d.note + '<br>' + 
				'Transaction Start Date: ' + d.date_created + '<br>' + 
				'Transaction Completion Date: ' + d.date_completed + '<br>'
		} else {
			var tooltip_text = 'User 1: ' + d.source.name + '<br>' + 
				'User 2: ' + d.target.name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Messages: ' + d.note  + '<br>'
		}

		link_tooltip
			.html(tooltip_text)
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 100) + "px")
			.style("color", "white")
	})
	.on("mouseleave", function(event, d) {
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
	});

	//show different message if there are no nodes
	if (nodesdata.length==0){
		document.getElementById("nonodesfound").style.display = "block";

		//start simulation
		if (!start) {
		simulation.nodes(nodesdata);
		//simulation
		//simulation.force("charge", d3.forceManyBody().strength((1/linksdata.length)*charge));
		simulation.force("link").links(linksdata);//.strength(linksdata.length*link_strength/1000);
		//simulation.force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))  
		simulation.alpha(0.2).restart();

		}

		//make graphs
		linegraphs(linksdata);
		userbargraph(nodesdata);
		emojibargraph(linksdata);
	
	} else {
		//hide no nodes message
		document.getElementById("nonodesfound").style.display = "none";

		//start simulation
		if (!start) {
		simulation.nodes(nodesdata);
		//simulation
		simulation.force("link").links(linksdata).strength(link_strength);
		simulation.force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))  
		simulation.alpha(0.2).restart();
		}

		//make graphs
		linegraphs(linksdata);
		userbargraph(nodesdata);
		emojibargraph(linksdata);
	}

}

//add functions to filter buttons
// document.getElementById("searchsubmit").addEventListener('click',
// 	function(event){document.getElementById("search").value = '';namevalue=[];document.getElementById("namesearches").innerHTML="";filter(event);});
document.getElementById("datesubmit").addEventListener('click',filter);
//document.getElementById("chargefilter").addEventListener('change',filter);
document.getElementById("showall").addEventListener('click',
	function(){
		document.getElementById("search").value = '';document.getElementById("namesearches").innerHTML="";
		document.getElementById("msg").value="";
		document.getElementById("startdate").value="2018-07-01";document.getElementById("enddate").value="2019-02-28";
		namevalue=[];
		click_namevalue=[];
		generateGraph([],[]);
	});


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//filter data by name/date and call network generation function
// Added functionality for filter by clicking: change type = "click"
function filter(event, type = "filter", start = false){
	var filternodes = venmoData.nodes, filterlinks = venmoData.links;

	// namevalue is now a global variable set in line (approximately 197)
	// Also it's a list now, so using the filter bar adds to this list
	if (!namevalue.includes(document.getElementById("search").value) && (document.getElementById("search").value !== '') ) {
		namevalue.push(document.getElementById("search").value);
		document.getElementById("namesearches").innerHTML = document.getElementById("namesearches").innerHTML +document.getElementById("search").value+"; ";
	};
	

	// Similarly, there's a second global list that keeps track of nodes that have been clicked on and their neighbors
	// If we're using this function on a click, add the clicked node to add to the list of clicked nodes
	if ((type == "click") && (!click_namevalue.includes(event.name))) {
		click_namevalue.push(event.name);
	}

	//console.log(namevalue,click_namevalue);

	var startdatevalue = document.getElementById("startdate").value === '' ? "2010-01-01" : document.getElementById("startdate").value;
	var enddatevalue = document.getElementById("enddate").value === '' ? "2030-01-01" : document.getElementById("enddate").value;
	//var chargesvalue = document.getElementById("chargeorpay").value === 'all' ? '.*' : document.getElementById("chargeorpay").value;
	//console.log(namevalue);console.log(startdatevalue);console.log(enddatevalue);//console.log(chargesvalue);
	var msgvalue = document.getElementById("msg").value === '' ? /.*/ : document.getElementById("msg").value;


	//filter links and nodes
	filterlinks = filterlinks.filter(function(d){
		//console.log(d);
		reformatDate = d.date_created[0].slice(6,10)+"-"+d.date_created[0].slice(0,2) +"-"+d.date_created[0].slice(3,5);

		var searchcontains=false;

		//handle case sensitivity? maybe later
		for (var i = 0; i < namevalue.length; i++) {
			if ((d.source.name.includes(namevalue[i])) || (d.target.name.includes(namevalue[i]))) {
				searchcontains = true;
			}
		}

		var notes = d.note.join()
		//return (((d.source.display_name.search(namevalue) !== -1) || (d.target.display_name.search(namevalue) !== -1)) 
		//	&& (reformatDate >= startdatevalue)
		//	&& (reformatDate <= enddatevalue))
		return ( ( (namevalue.length==0 && click_namevalue.length==0 && document.getElementById("msg").value==='')
			|| searchcontains || (namevalue.includes(d.source.name)) || (namevalue.includes(d.target.name)) 
			|| (click_namevalue.includes(d.source.name)) || (click_namevalue.includes(d.target.name))  )
			&& (reformatDate >= startdatevalue)
			&& (reformatDate <= enddatevalue)
			|| (notes.search(msgvalue) > 0))
	});

	var allnames = []

	//for (var i = 0; i < filterlinks.length; i++) {
	// now capped at 1000 edges
	for (var i = 0; i < Math.min(filterlinks.length,1000); i++) {
		allnames.push(filterlinks[i].source.name);
		allnames.push(filterlinks[i].target.name);
	}
	
	//capped at 1000 edges
	if (filterlinks.length > 1000) {
		filterlinks = filterlinks.slice(0,1000);
	}

	filternodes = filternodes.filter(function(d){
		return allnames.includes(d.name)
	});

	//for debugging
	//console.log(filterlinks);console.log(filternodes);

	//generate new network
	generateGraph(filternodes,filterlinks,start);
	d3.selectAll("circle").raise(); // circles on top of the lines

	//simulation.nodes(filternodes);
	//simulation.force("link").links(filterlinks);
	if (!start) {
		simulation.force("charge", d3.forceManyBody().strength(charge*10));
		simulation.force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength)); 
		simulation.alpha(1).restart();
	}


	//return simulation;
}

function start_sim() {
simulation = d3.forceSimulation(venmoData.nodes)              // Force algorithm is nodes
      .force("link", d3.forceLink(venmoData.links).strength(link_strength)                // This force provides links between nodes
            .id(function(d) { return d.id; })                     
      )
      //.force("charge", d3.forceManyBody().strength(charge))         // Repulsion between nodes.
      .force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))     // Attracts nodes to the center of the svg area
	  //.force("x", d3.forceX()) // Can mess around with these
      //.force("y", d3.forceY())
	  //.stop()
	  .on("tick", ticked);


 // This function is run at each iteration of the force algorithm, updating the nodes position.
 function ticked() {
	node
         .attr("cx", function (d) { return d.x = Math.max(radius,Math.min(svg_width_px - radius, d.x)); })
         .attr("cy", function(d) { return d.y = Math.max(radius,Math.min(svg_height_px - radius, d.y)); });
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y;})
        .attr("x2", function(d) { return d.target.x;})
        .attr("y2", function(d) { return d.target.y;}); 
  }

}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////
//create line graph over days

function linegraphs(linksdata){

d3.select("#datesvg").remove();
d3.select("#timesvg").remove();

var lineW = window.innerWidth*0.45;
var lineH = window.innerHeight*0.6;
var margin = 20;
var linegraphsvg = d3.select("#graphoverdate")
	        .append("svg")
	        .attr("width", 2*margin + lineW)
	        .attr("height", 2*margin + lineH)
	        .attr("id","datesvg");


linegraphtmp = {};

//console.log(linksdata);
mdy_formatter = d3.timeParse("%m/%d/%Y");

for (var i = 0; i < linksdata.length; i++) {
	for (var j = 0; j < (linksdata)[i].date_created.length; j++) {
		mydate = ((linksdata)[i].date_created)[j].slice(0,10);
		datekey = mdy_formatter(mydate);
		if (datekey in linegraphtmp){
			linegraphtmp[datekey] += 1; 
		} else{
			linegraphtmp[datekey] = 1;
		}
	}
}

linegraphData = [];

for (const key of Object.keys(linegraphtmp)) {
	linegraphData.push({"date":key,"value":linegraphtmp[key]});
}

linegraphData.sort((a,b) => new Date(a.date) - new Date(b.date));

//console.log(linegraphData);

var x = d3.scaleTime()
      .domain(d3.extent(linegraphData, function(d) { return new Date(d.date); }))
      .range([2*margin, lineW]);

linegraphsvg.append("g")
	.attr("transform", "translate("+0+"," + lineH + ")")
	.call(d3.axisBottom(x));

var y = d3.scaleLinear()
  	.domain([0, d3.max(linegraphData, function(d) { return +d.value; })])
  	.range([ lineH , margin + 10]);


//console.log(typeof linegraphData[0].date,x(linegraphData[0].date),y(linegraphData[0].value));

linegraphsvg.append("g")
	.attr("transform", "translate("+2*margin+",0)")
  	.call(d3.axisLeft(y).tickSize(0));

datetitle = linegraphsvg.append('text')
	.attr('transform','translate(' + lineW / 2 + ',20)')
	.attr('text-anchor','middle')
	.attr('fill','black')
	.attr('font-size', '16px')
	.attr('font-weight', 'bold')
	.attr('x', 0)
	.attr('y', 0)
	.style("opacity",1)
	.text('Total Transactions by Date');

linegraphsvg.append("path")
  	.datum(linegraphData)
  	.attr("fill", "none")
  	.attr("stroke", "orange")
  	.attr("stroke-width", 3)
  	.attr("d", d3.line()
    	.x(function(d) { return x(new Date(d.date)) })
    	.y(function(d) { return y(d.value) }) );

//console.log(linegraphData);

linegraphsvg.append("text").attr("x",lineW/2-margin*9).attr("y", margin).attr("id","dateinfo1");
linegraphsvg.append("text").attr("x",lineW/2-margin*9).attr("y", margin+20).attr("id","dateinfo2");

var line_tooltip_left = d3.select("#graphoverdate").append("div")
		.attr("class", "tooltip")
		.attr('id', 'line_tooltip_left')
		.style("opacity", 0)
		.style("top", -2 * margin + "px");

linegraphsvg.selectAll("circle")
  	.data(linegraphData)
  	.join("circle")
  	.attr("fill", "green")
  	.attr("r",5)
  	.attr("cx",function(d) { return x(new Date(d.date)) })
   	.attr("cy",function(d) { return y(d.value) })
   	.on("mouseover",function(e,d){
		line_tooltip_left.transition()
			.duration(100)
			.style("opacity", 1);

		line_tooltip_left
			.html('Date: ' + d.date + '<br>' + 
			'Transaction count: ' + d.value)
			.style("left", (event.pageX ) + 10 + "px")
			.style("top", (event.pageY - 50) + "px")
			.style("color", "white");
		

		d3.select(this).transition()
			.duration(500)
			.attr('r',10);

   		//d3.select("#dateinfo1").text("Date: "+ d.date);
   		//d3.select("#dateinfo2").text("Transaction count: " + d.value );
   	})
   	.on("mouseout",function(e,d){
   		//d3.select("#dateinfo1").text("" );
      	//d3.select("#dateinfo2").text("" );
		line_tooltip_left.transition()
			.duration(100)
			.style("opacity", 0);

		d3.select(this).transition()
			.duration(100)
			.attr('r',5);
   	});

///////////////////////////////////////////////////////////////////////////////////
//create line graph over time

var timegraphsvg = d3.select("#graphovertime")
	        .append("svg")
	        .attr("width", 2*margin + lineW)
	        .attr("height", 2*margin + lineH)
	        .attr("id","timesvg");


timegraphtmp = {};

//hms_formatter = d3.timeParse("%H:%M:%S");

for (var i = 0; i < linksdata.length; i++) {
	for (var j = 0; j < (linksdata)[i].date_created.length; j++) {
		timekey = +((linksdata)[i].date_created)[j].slice(12,14);
		if (timekey in timegraphtmp){
			timegraphtmp[timekey] += 1; 
		} else{
			timegraphtmp[timekey] = 1;
		}
	}
}

timegraphData = [];

for (const key of Object.keys(timegraphtmp)) {
	timegraphData.push({"time":key,"value":timegraphtmp[key]});
}


//console.log(timegraphData);
//console.log(new Date("01/01/1900 00:00:00"));

var timex = d3.scaleLinear()
      .domain([0,24])
      .range([2*margin, lineW]);

timegraphsvg.append("g")
	.attr("transform", "translate("+0+"," + lineH + ")")
	.call(d3.axisBottom(timex).tickFormat(x => x+":00"));

var timey = d3.scaleLinear()
  	.domain([0, d3.max(timegraphData, function(d) { return +d.value; })])
  	.range([ lineH, margin + 10]);


//console.log(typeof linegraphData[0].date,x(linegraphData[0].date),y(linegraphData[0].value));

timegraphsvg.append("g")
	.attr("transform", "translate("+2*margin+",0)")
  	.call(d3.axisLeft(timey).tickSize(0));

timetitle = timegraphsvg.append('text')
			.attr('transform','translate(' + lineW / 2 + ',20)')
			.attr('text-anchor','middle')
			.attr('fill','black')
			.attr('font-size', '16px')
			.attr('font-weight', 'bold')
			.attr('x', 0)
			.attr('y', 0)
			.style("opacity",1)
			.text('Total Transactions by Time of Day');

timegraphsvg.append("path")
  	.datum(timegraphData)
  	.attr("fill", "none")
  	.attr("stroke", "green")
  	.attr("stroke-width", 3)
  	.attr("d", d3.line()
    	.x(function(d) { return timex(+d.time) })
    	.y(function(d) { return timey(d.value) }) );

timegraphsvg.append("text").attr("x",lineW/2 - 3*margin).attr("y", margin).attr("id","timeinfo1");
timegraphsvg.append("text").attr("x",lineW/2 - 3*margin).attr("y", margin+20).attr("id","timeinfo2");

var line_tooltip_right = d3.select("#graphovertime").append("div")
		.attr("class", "tooltip")
		.attr('id', 'line_tooltip_right')
		.style("opacity", 0)
		.style("top", -2 * margin + "px");

timegraphsvg.selectAll("circle")
  	.data(timegraphData)
  	.join("circle")
  	.attr("fill", "orange")
  	.attr("r",5)
  	.attr("cx",function(d) { return timex(+d.time) })
   	.attr("cy",function(d) { return timey(d.value) })
   	.on("mouseover",function(e,d){
		line_tooltip_right.transition()
			.duration(100)
			.style("opacity", 1);

		line_tooltip_right
			.html('Hour: ' + d.time + ':00 EST <br>' + 
			'Transaction count: ' + d.value)
			.style("left", (event.pageX ) + 10 + "px")
			.style("top", (event.pageY - 50) + "px")
			.style("color", "white");
		

		d3.select(this).transition()
			.duration(500)
			.attr('r',10);


   		//d3.select("#timeinfo1").text("Hour: "+ d.time+":00 EST");
   		//d3.select("#timeinfo2").text("Transaction count: " + d.value );
   	})
   	.on("mouseout",function(e,d){
   		//d3.select("#timeinfo1").text("" );
      	//d3.select("#timeinfo2").text("" );
		line_tooltip_right.transition()
			.duration(100)
			.style("opacity", 0);

		d3.select(this).transition()
			.duration(100)
			.attr('r',5);

   	});
} // function end




linegraphs(venmoData.links);

//////////////////////////////////////////////////////////////////////////////////////////////////////

// Function to make a bar graph showing the most active users (number of transactions) in the time span
function userbargraph(nodesdata){

	d3.select("#usersvg").remove();
	var userW = window.innerWidth*0.45;
	var userH = window.innerHeight*0.6;
	var margin = 20;
	var n_bars = 40;
	var usersvg = d3.select("#usergraph")
				.append("svg")
				.attr("width", 2*margin + userW)
				.attr("height", 2*margin + userH)
				.attr("id","usersvg");


	if (nodesdata.length > 0) {

	// calculate bar width
	var bar_width = (userW) / n_bars -1;

	

	// Sort the nodes by decreasing number of transactions (and take the first n)
	sortedNodes = nodesdata.slice().sort((a, b) => d3.descending(a.n_trans, b.n_trans)).slice(0,n_bars);

	// Construct the y scale based on the largest number of transactions
	var max_trans = sortedNodes[0].n_trans;
	var barscale = d3.scaleLinear().domain([1,max_trans]).range([userH,margin + 10]);
	var xscale = d3.scaleBand().range([0,userW + margin]);
	//console.log(sortedNodes);

	// Draw some bars
	var bars = usersvg.selectAll("rect").data(sortedNodes) // attatch to the data
			.join("rect")
			// Make some rectangles (https://www.youtube.com/watch?v=lW3I7yz5nVo)
			.attr("transform", function(d, i) {
				return "translate(" + (Number(margin) + (i * bar_width) + i) + "," + barscale(Number(d.n_trans)) + ")";
			})
			.attr("height", function(d) {
				return (userH - barscale(Number(d.n_trans)));
			})
			.attr("width",bar_width)
			.attr("fill", "#3d95ce")
			.attr("stroke-width","2px")
			.attr('stroke',function(d){
				el = document.getElementById(d.name);
				if(el && el.style.strokeWidth == "5px" ){
					return '#39FF14';
				} else {
					return 'white';
				}
			});

	d3.select('#usersvg').append("text").attr("x",userW/3).attr('y',userH+15).text("Users - hover over bars to see details");
	
	// X axis
	usersvg.append('g')
		.attr('class','xaxis')
		.attr('transform', 'translate(' + (margin / 2 +8) + ',' + userH + ')')
		.call(d3.axisBottom(xscale).tickSize(0));
	
	// Y axis
	usersvg.append('g')
		.attr('class','yaxis')
		.attr('transform','translate(' + (margin / 2 + 8) + ',' + 0 + ')')
		.call(d3.axisLeft(barscale).ticks(5).tickSize(0));
		/*.append('text')
			.attr('transform','translate(-130,40) rotate(-90)')
			.attr('text-anchor', 'end')
			.attr('fill', 'black')
			.attr('font-size', '12px')
			.attr('font-weight', 'bold')
			.attr('x', 0)
			.attr('y', 100)
			.text('Number of Transactions');*/
	
	usertitle = usersvg.append('text')
		.attr('transform','translate(' + userW / 2 + ',20)')
		.attr('text-anchor','middle')
		.attr('fill','black')
		.attr('font-size', '16px')
		.attr('font-weight', 'bold')
		.attr('x', 0)
		.attr('y', 0)
		.style("opacity",1)
		.text('Most Active Users (Total Transactions)');


	// Bars get a tooltip too!
	var bar_tooltip = d3.select("#usergraph").append("div")
		.attr("class", "tooltip")
		.attr('id', 'bar_tooltip')
		.style("opacity", 0)
		.style("top", -2 * margin + "px");
	
	// bars turn to black on hover and show the tooltip
	bars
	.on("mouseover", function(event, d) {
		d3.select(this).transition()
			.duration(100)
			.style("fill", "black");
		
		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		bar_tooltip
			.html('Username: ' + d.name + '<br>' + 
			'Number of Transactions: ' + d.n_trans + '<br>' + 
			'Number of Neighbors: ' + d.neighbors.length)
			.style("left", (event.pageX ) +60+ "px")
			.style("top", (event.pageY - 80) + "px")
			.style("color", "white")
		
	})
	.on("mouseout", function(event, d) {
		d3.select(this).transition()
			.duration(100)
			.style("fill", "#3d95ce");

		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

	})

// on click, outline the bar and the corresponding graph node in green. If already clicked, change back to regular outlines.
	.on("click", function(event,d){

		myel = d3.select(this);
		//console.log(typeof myel.style("fill"));

		if (myel.style("stroke")== "rgb(57, 255, 20)"){
			myel.style("stroke", "white");
		} else {
			myel.style("stroke", "#39FF14");
		}

		el = document.getElementById(d.name);
		if (el.style.strokeWidth == "5px" ){
			el.style.strokeWidth = "0px";
			el.style.stroke = "none";
		} else {
			el.style.strokeWidth = "5px";
			el.style.stroke = "#39FF14";
		}
		
	});

} // end of if statement

};

// Call the function
userbargraph(venmoData.nodes);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function to make a bar graph showing the most used emojis in the time span
function emojibargraph(linksdata){
	d3.select("#emojisvg").remove();

	var emojiW = window.innerWidth*0.45;
	var emojiH = window.innerHeight*0.6;
	var margin = 20;
	var n_bars = 50;
	var emojisvg = d3.select("#emojigraph")
				.append("svg")
				.attr("width", 2*margin + emojiW)
				.attr("height", 2*margin + emojiH)
				.attr("id","emojisvg");

	// calculate bar width
	var bar_width = (emojiW) / n_bars;

	// Get ready for some emoji math
	emojicounts = {}; // cumulative counts

	// a function that returns true for (most) emojis
	const regexExp = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/gi;

	// hiding all regex code for now
	// for (var i = 0; i < linksdata.length; i++) { //linksdata.length
	// 	notes = linksdata[i].note; // pull out the notes
	// 	for (var j = 0; j < notes.length; j++) { // some of the links have multiple notes, so loop through each one
	// 		if(regexExp.test(notes[j])) { // test the note for emojis
	// 			note_array = Array.from(notes[j]); // If so, split it into character / emoji chunks //note_array = regexExp.exec(notes[j])//
	// 			for (let characters of note_array) { // Loop through these chunks
	// 				console.log(regexExp.test(characters));
	// 				if (regexExp.test(characters)) { // If it's an emoji add it to the dictionary
	// 					if (characters in emojicounts) {
	// 						emojicounts[characters]++
	// 					} else {
	// 						emojicounts[characters] = 1
	// 					}
	// 				}
	// 			}
	// 		}
	// 	}
	// };
	// woof

	//someone made this splitter that can handle emojis
	var splitter = new GraphemeSplitter();

	for (var i = 0; i < linksdata.length; i++) { //linksdata.length
		var notes = linksdata[i].note; // pull out the notes
		for (var j = 0; j < notes.length; j++) { // some of the links have multiple notes, so loop through each one
			var note_array = splitter.splitGraphemes(notes[j]); // split into characters/emojis
			for (var k = 0; k < note_array.length; k++) {
				if (allemojis.includes(note_array[k])){ // allemojis is the list of all emojis we read in earlier, check if char is in allemojis
					if (note_array[k] in emojicounts) { // add to emoji dictionary
							emojicounts[note_array[k]]++
						} else {
							emojicounts[note_array[k]] = 1
						}
					}
				}
			}
		};


	// Now we have to turn that dict into a list of smaller dicts because thats the only way I know how to sort
	emojicounts_list = [];
	for (const [key, value] of Object.entries(emojicounts)) {
		if ((key!=="â€™") && (key!=="")) {
			emojicounts_list.push({"emoji":key, "count": value});
		}
	};

	if (emojicounts_list.length == 0){
		d3.select("#emojisvg").append("text").text("No emojis used!").attr("x",emojiW/2).attr("y",emojiH/2);
		return -1;
	}


	// sort, as promised
	sorted_emojis = emojicounts_list.slice().sort((a, b) => d3.descending(a.count, b.count)).slice(0,n_bars);



	//bubble chart!
	var bubble = data => d3.pack()
    .size([emojiW, emojiH])
    .padding(3)(d3.hierarchy({ children: data }).sum(d => d.count));

    var root = bubble(sorted_emojis);

    //circles (no colors/outlines yet)
    var bub = emojisvg.selectAll('circle')
    					.data(root.children)
    					.join('circle')
    					.attr('transform',d=>'translate('+(d.x- (d.r+15)/2)+','+(3*margin+d.y)+')')
    					.attr('r',d=>d.data.r);

    //the actual emoji text
    var labels = emojisvg.selectAll('text')
    					.data(root.children)
    					.join('text')
    					.attr('transform',d=>'translate('+(d.x - (d.r+15)/2)+','+(3*margin+d.y)+')')
    					.style('font-size',d=>d.r+15)
    					.style('font-family','emoji')
    					.text(d=>d.data.emoji);
	

	emojititle = emojisvg.append('text')
		.attr('transform','translate(' + emojiW / 2 + ',20)')
		.attr('text-anchor','middle')
		.attr('fill','black')
		.attr('font-size', '16px')
		.attr('font-weight', 'bold')
		.attr('x', 0)
		.attr('y', 0)
		.style("opacity",1)
		.text('Most Frequently Used Emojis');


	// The rest is just making a bar graph
	// Construct the y scale based on the largest number of transactions
	// var max_count = sorted_emojis[0].count;
	// var barscale = d3.scaleLinear().domain([0.5,max_count]).range([emojiH,5]);
	// var xscale = d3.scaleBand().domain(sorted_emojis.map(d => d.emoji)).range([0,emojiW]);

	// // Draw some bars
	// var bars =emojisvg.selectAll("g").data(sorted_emojis) // attatch to the data
	// 		.enter().append("g")
	// 		// Make some rectangles (https://www.youtube.com/watch?v=lW3I7yz5nVo)
	// 		.attr("transform", function(d, i) {
	// 			return "translate(" + (xscale(d.emoji)+margin+xscale.bandwidth()/2-bar_width/2) + "," + barscale(Number(d.count)) + ")";
	// 		})
	// 		.append("rect").attr("height", function(d) {
	// 			return (emojiH - barscale(Number(d.count)));
	// 		})
	// 		.attr("width",bar_width)
	// 		.attr("fill", "lightsteelblue")
	// 		.attr('stroke','white');
	
	// // X axis
	// emojisvg.append('g')
	// 	.attr('class','xaxis')
	// 	.attr('transform', 'translate(' + (margin) + ',' + emojiH + ')')
	// 	.style('font-size','20px')
	// 	.call(d3.axisBottom(xscale).tickSize(0));
	
	// // Y axis
	// emojisvg.append('g')
	// 	.attr('class','yaxis')
	// 	.attr('transform','translate(' + (margin) + ',' + 0 + ')')
	// 	.call(d3.axisLeft(barscale).ticks(5).tickSize(0));
		/*.append('text')
			.attr('transform','translate(-130,40) rotate(-90)')
			.attr('text-anchor', 'end')
			.attr('fill', 'black')
			.attr('font-size', '12px')
			.attr('font-weight', 'bold')
			.attr('x', 0)
			.attr('y', 100)
			.text('Number of Transactions');*/

	// Bars get a tooltip too!
	var bar_tooltip = d3.select("#emojigraph").append("div")
		.attr("class", "tooltip")
		.attr('id', 'bar_tooltip_e')
		.style("opacity", 0)
		.style("top", -2 * margin + "px");
	
	// hover over emojis to show the tooltip
	labels
	.on("mouseover", function(event, d) {	
		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		bar_tooltip
			.html('Emoji: ' + d.data.emoji + '<br>' + 
			'Number of Uses: ' + d.data.count)
			.style("left", (event.pageX - 25) + "px")
			.style("top", (event.pageY - 20) + "px")
			.style("color", "white");		
	})
	.on("mouseout", function(event, d) {
		// d3.select(this).transition()
		// 	.duration(100)
		// 	.style("fill", "lightsteelblue");

		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
	});

};
emojibargraph(venmoData.links);

//create emoji graph
/*var emojiW = "45vw";
var emojiH = "45vh";
var emojisvg = d3.select("#emojigraph")
	        .append("svg")
	        .attr("width", emojiW)
	        .attr("height", emojiH);*/
}); //end of then function

</script>

<!--- emoji picker menu --->
<script src="fgEmojiPicker.js"></script>
    <script>
        const emojiPicker = new FgEmojiPicker({
            trigger: 'button',
            removeOnSelection: false,
            closeButton: true,
            position: ['bottom', 'right'],
            preFetch: true,
            insertInto: document.getElementById('msg'),
            emit(obj, triggerElement) {
            	var b=7;
                //console.log(obj, triggerElement);
            }
        });
    </script>


<h2 id="design-choices">Design Choices and Reflection</h2>
<div>
<p>
Kiran Gite and Shane Weisberg, for MIT 6.859 Interactive Data Visualization, Spring 2021. <a href="https://github.com/6859-sp21/final-project-byo_venmo_transaction_network" target=" blank"> [Source code]</a>
</p>
</div>


</body>

</html>