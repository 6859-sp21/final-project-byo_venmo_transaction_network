<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://d3js.org/d3.v6.js"></script>

<style type="text/css">
svg {
	display: block;
	margin: auto;
}

body {
	font-size: 15px;
	font-family: Helvetica, sans-serif;
}

h1{
	color: #3d95ce;
}

.filtering{
	display: inline-block;
	padding: 10px;
	margin-right: 20px;
}

.biggraph{
	border-style: solid;
	border-width: 1px;
}

.smallgraph{
	border-style: solid;
	display: inline-block;
	margin-left: 50px;
	border-width: 1px;
}

</style>

</head>

<body>

<h1>Build Your Own Venmo Network</h1>

<div id="searchfilter" class="filtering">
	<label for="search">Search by name:</label><input type="text" id="search"><input id="searchsubmit" type="button" value="Search">
</div>
<div id="datefilter" class="filtering">
	<label for="startdate">Start date:</label><input type="date" id="startdate" value="2018-07-01" min="2018-07-01" max="2019-02-28">
	<label for="enddate">End date:</label><input type="date" id="enddate" value="2019-02-28" min="2018-07-01" max="2019-02-28">
	<input id="datesubmit" type="button" value="Filter">
</div>
<div id="chargefilter" class="filtering">
<label for="chargeorpay">Charges, payments, or both:</label>
<select id="chargeorpay">
  <option value="all">All</option>
  <option value="charges">Charges</option>
  <option value="payments">Payments</option>
</select>
</div>
<div id="showalldiv" class="filtering">
	<input id="showall" type="button" value="Show all">
</div>


<div id="networkvis" class="biggraph"></div>

<div id="graphovertime" class="biggraph"></div>

<div id="usergraph" class="smallgraph"></div>

<div id="emojigraph" class="smallgraph"></div>


<script>

Promise.all([
//d3.csv("placeholder.csv")
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-byo_venmo_transaction_network/main/venmo_gt4_first200k_medium.json")
])
.then(function(dt){

venmoData = dt[0];
console.log(venmoData.links);
console.log(venmoData.nodes);

// Some variables
var radius = 3,
	link_strength = 0.5
	center_strength = 1
	charge = -0.01;

//create network
var networkW = "90vw";
var networkH = "80vh";
var networksvg = d3.select("#networkvis")
	        .append("svg")
			.attr("id", "networkvis_inner")
	        .attr("width", networkW)
	        .attr("height", networkH);


var g = networksvg.append("g")
    .attr("class", "everything");

var zoom_handler = d3.zoom()
    .on("zoom", zoom_actions)
    .scaleExtent([1,8]);

zoom_handler(networksvg);  

function zoom_actions({transform}){
    g.attr("transform", transform);
}


// Initialize the network edges
var link = g
    		.selectAll("line")
			.data(venmoData.links)
			.join("line")
			.style("stroke", "#aaa");
			// I forgot to implement this...
			//.style("stroke_width", function(d) {
			//	return d.weight
			//})


// Initialize the nodes
var node = g
			.selectAll("circle")
			.data(venmoData.nodes)
			.join("circle")
			.attr("r", radius)
			.style("fill", "black");


// There's probably a better way of locating the center of the network...
var width = networksvg.attr("width"),
	height = networksvg.attr("height"),
	wind_width = window.innerWidth,
	svg_width = d3.select('#networkvis_inner').attr('width').slice(0,2)/100,
	svg_width_px = wind_width * svg_width,
	wind_height = window.innerHeight,
	svg_height = d3.select('#networkvis_inner').attr('height').slice(0,2)/100,
	svg_height_px = wind_height * svg_height;

//console.log(wind_width);console.log(svg_width);console.log(svg_width_px);


// Forces for node positioning			
var simulation = d3.forceSimulation(venmoData.nodes)              // Force algorithm is nodes
      .force("link", d3.forceLink(venmoData.links).strength(link_strength)                // This force provides links between nodes
            .id(function(d) { return d.id; })                     
      )
      .force("charge", d3.forceManyBody().strength(charge))         // Repulsion between nodes.
      .force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))     // Attracts nodes to the center of the svg area
	  //.force("x", d3.forceX()) // Can mess around with these
      //.force("y", d3.forceY())
	  .on("tick", ticked);


 // This function is run at each iteration of the force algorithm, updating the nodes position.
 function ticked() {
	node
         .attr("cx", function (d) { return d.x = Math.max(radius,Math.min(svg_width_px - radius, d.x)); })
         .attr("cy", function(d) { return d.y = Math.max(radius,Math.min(svg_height_px - radius, d.y)); });
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y;})
        .attr("x2", function(d) { return d.target.x;})
        .attr("y2", function(d) { return d.target.y;}); 
  }



function generateGraph(nodesdata,linksdata){
	//console.log(nodesdata,linksdata);
	link = link.data(linksdata)
		.join("line")
		.style("stroke", "#aaa");
		// I forgot to implement this...
		//.style("stroke_width", function(d) {
		//	return d.weight
		//})



	node = node.data(nodesdata)
		.join("circle")
		.attr("r", radius)
		.style("fill", "black");


	simulation.nodes(nodesdata);
	simulation.force("link").links(linksdata);

	simulation.alpha(2).restart();

}


document.getElementById("searchsubmit").addEventListener('click',filter);

document.getElementById("datesubmit").addEventListener('click',filter);

//document.getElementById("chargefilter").addEventListener('change',filter);

document.getElementById("showall").addEventListener('click',function(){generateGraph(venmoData.nodes,venmoData.links);});


function filter(event){
	var filternodes = venmoData.nodes, filterlinks = venmoData.links;

	var namevalue = document.getElementById("search").value === '' ? '.*' : document.getElementById("search").value;
	var startdatevalue = document.getElementById("startdate").value === '' ? "2010-01-01" : document.getElementById("startdate").value;
	var enddatevalue = document.getElementById("enddate").value === '' ? "2030-01-01" : document.getElementById("enddate").value;
	//var chargesvalue = document.getElementById("chargeorpay").value === 'all' ? '.*' : document.getElementById("chargeorpay").value;

	console.log(namevalue);console.log(startdatevalue);console.log(enddatevalue);//console.log(chargesvalue);

	filterlinks = filterlinks.filter(function(d){
		reformatDate = d.date_created[0].slice(6,10)+"-"+d.date_created[0].slice(0,2) +"-"+d.date_created[0].slice(3,5);
		return (((d.source.display_name.search(namevalue) !== -1) || (d.target.display_name.search(namevalue) !== -1)) 
			&& (reformatDate >= startdatevalue)
			&& (reformatDate <= enddatevalue))
	});

	var allnames = []

	for (var i = 0; i < filterlinks.length; i++) {
		allnames.push(filterlinks[i].source.name);
		allnames.push(filterlinks[i].target.name);
	}

	filternodes = filternodes.filter(function(d){
		return allnames.includes(d.name)
	});

	console.log(filterlinks);console.log(filternodes);

	generateGraph(filternodes,filterlinks);

}


//create line graph over time
var lineW = "90vw";
var lineH = "60vh";
var networksvg = d3.select("#graphovertime")
	        .append("svg")
	        .attr("width", lineW)
	        .attr("height", lineH);

//create user graph
var userW = "45vw";
var userH = "45vh";
var networksvg = d3.select("#usergraph")
	        .append("svg")
	        .attr("width", userW)
	        .attr("height", userH);

//create emoji graph
var emojiW = "45vw";
var emojiH = "45vh";
var networksvg = d3.select("#emojigraph")
	        .append("svg")
	        .attr("width", emojiW)
	        .attr("height", emojiH);

}) //end of then function

</script>


<h2 id="design-choices">Design Choices and Reflection</h2>
<div>
<p>
Kiran Gite and Shane Weisberg, for MIT 6.859 Interactive Data Visualization, Spring 2021. <a href="https://github.com/6859-sp21/final-project-byo_venmo_transaction_network" target=" blank"> [Source code]</a>
</p>
</div>


</body>

</html>