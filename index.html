<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://d3js.org/d3.v6.js"></script>

<style type="text/css">
svg {
	display: block;
	margin: auto;
}

body {
	font-size: 15px;
	font-family: Helvetica, sans-serif;
}

h1{
	color: #3d95ce;
}

.filtering{
	display: inline-block;
	padding: 10px;
	margin-right: 20px;
}

.biggraph{
	border-style: solid;
	border-width: 1px;
}

.smallgraph{
	border-style: solid;
	display: inline-block;
	margin-left: 50px;
	border-width: 1px;
}


div.tooltip {
	position: absolute;
	text-align: left;
	width: auto;
	height: auto;
	padding: 3px;
	font: 14px sans-serif;
	font-weight: 300;
	border: 2px;
	border-radius: 0px;
	pointer-events: none;
	background-color: #3d95ce;
}

div.tooltip_img {
	position: absolute;
	text-align: center;
	width: 50px;
	height: 50px;
	padding: 0px;
	font: 14px sans-serif;
	font-weight: 900;
	border: 0px;
	border-radius: 0px;
	pointer-events: none;
}

</style>

</head>

<body>

<h1>Build Your Own Venmo Network</h1>

<div id="searchfilter" class="filtering">
	<label for="search">Search by name:</label><input type="text" id="search"><input id="searchsubmit" type="button" value="Search">
</div>
<div id="datefilter" class="filtering">
	<label for="startdate">Start date:</label><input type="date" id="startdate" value="2018-07-01" min="2018-07-01" max="2019-02-28">
	<label for="enddate">End date:</label><input type="date" id="enddate" value="2019-02-28" min="2018-07-01" max="2019-02-28">
	<input id="datesubmit" type="button" value="Filter">
</div>
<div id="chargefilter" class="filtering" style="display:none">
<label for="chargeorpay">Charges, payments, or both:</label>
<select id="chargeorpay">
  <option value="all">All</option>
  <option value="charges">Charges</option>
  <option value="payments">Payments</option>
</select>
</div>
<div id="showalldiv" class="filtering">
	<input id="showall" type="button" value="Show all">
</div>


<div id="networkvis" class="biggraph"></div>

<div id="graphovertime" class="biggraph"></div>

<div id="usergraph" class="smallgraph"></div>

<div id="emojigraph" class="smallgraph"></div>


<script>

Promise.all([
//d3.csv("placeholder.csv")
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-byo_venmo_transaction_network/main/venmo_gt4_first200k_small.json")
])
.then(function(dt){

venmoData = dt[0];
console.log(venmoData.links);
console.log(venmoData.nodes);

// Some variables
var radius = 3,
	link_strength = 0.5,
	center_strength = 1,
	charge = -0.01,
	image_left = 100
	image_top = 100;

//create network
var networkW = "90vw";
var networkH = "80vh";
var networksvg = d3.select("#networkvis")
	        .append("svg")
			.attr("id", "networkvis_inner")
	        .attr("width", networkW)
	        .attr("height", networkH);


//zoom/pan functionality
var g = networksvg.append("g")
    .attr("class", "everything");

var zoom_handler = d3.zoom()
    .on("zoom", zoom_actions)
    .scaleExtent([1,8]);

zoom_handler(networksvg);  

function zoom_actions({transform}){
    g.attr("transform", transform);
}

// Tooltip for hovering over nodes
var node_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

// Tooltip for hovering over edges
var link_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

var img_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip_img")
               .style("opacity", 0);

// linear scale for calculating edge width (may have to adjust the upper bound later)
const stroke_scale = d3.scaleLinear().domain([1,102]).range([1,4]);

// Initialize the network edges
var link = g
    		.selectAll("line")
			.data(venmoData.links)
			.join("line")
			.style("stroke", "#aaa")
			.style("stroke_width", function(d) {
				return stroke_scale(d.weight);
			});


// Initialize the nodes
var node = g
			.selectAll("circle")
			.data(venmoData.nodes)
			.join("circle")
			.attr("r", radius)
			.style("fill", "black");


// There's probably a better way of locating the center of the network...
var width = networksvg.attr("width"),
	height = networksvg.attr("height"),
	wind_width = window.innerWidth,
	svg_width = d3.select('#networkvis_inner').attr('width').slice(0,2)/100,
	svg_width_px = wind_width * svg_width,
	wind_height = window.innerHeight,
	svg_height = d3.select('#networkvis_inner').attr('height').slice(0,2)/100,
	svg_height_px = wind_height * svg_height;



// Forces for node positioning			
var simulation = d3.forceSimulation(venmoData.nodes)              // Force algorithm is nodes
      .force("link", d3.forceLink(venmoData.links).strength(link_strength)                // This force provides links between nodes
            .id(function(d) { return d.id; })                     
      )
      .force("charge", d3.forceManyBody().strength(charge))         // Repulsion between nodes.
      .force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))     // Attracts nodes to the center of the svg area
	  //.force("x", d3.forceX()) // Can mess around with these
      //.force("y", d3.forceY())
	  .on("tick", ticked);


 // This function is run at each iteration of the force algorithm, updating the nodes position.
 function ticked() {
	node
         .attr("cx", function (d) { return d.x = Math.max(radius,Math.min(svg_width_px - radius, d.x)); })
         .attr("cy", function(d) { return d.y = Math.max(radius,Math.min(svg_height_px - radius, d.y)); });
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y;})
        .attr("x2", function(d) { return d.target.x;})
        .attr("y2", function(d) { return d.target.y;}); 
  }


//generate new network with updated data
function generateGraph(nodesdata,linksdata){
	//console.log(nodesdata,linksdata);

	//update link and node with new data
	link = link.data(linksdata)
		.join("line")
		.style("stroke", "#aaa")
		.style("stroke_width", function(d) {
			return stroke_scale(d.weight);
		})

	node = node.data(nodesdata)
		.join("circle")
		.attr("r", radius)
		.style("fill", "black");


	//restart simulation
	simulation.nodes(nodesdata);
	simulation.force("link").links(linksdata);

	simulation.alpha(2).restart();

}


//add functions to filter buttons
document.getElementById("searchsubmit").addEventListener('click',filter);
document.getElementById("datesubmit").addEventListener('click',filter);
//document.getElementById("chargefilter").addEventListener('change',filter);
document.getElementById("showall").addEventListener('click',function(){generateGraph(venmoData.nodes,venmoData.links);});

// Hovering functionality for the nodes and edges
node
	.on("mouseenter", function(event, d) {
		//console.log(d);
		// Show the tooltip with details
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0.8);

		node_tooltip
			.html('Name: ' + d.display_name + '<br>' + 
			'Number of Transactions: ' + d.n_trans + '<br>' + 
			'Number of Neighbors (Degree Centrality): ' + d.neighbors.length + '<br>' + 
			'Eigenvalue Centrality?')
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 50) + "px")
			.style("color", "white")

		// Also show a tooltip with the image
		img_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		img_tooltip
			.html(' ')   
			.style("left", event.pageX + 10  + "px")
			.style("top", event.pageY + 30 + "px")
			.style("background-image", "url(" + d.photo_url + ")");
	})
	// And get rid of them when the mouse moves
	.on("mouseleave", function(event, d) {
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

		img_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

	});

// Same for edges
link
	.on("mouseenter", function(event, d) {
		//console.log(d);
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0.9);
		
		// Slightly different messages for edges with weight 1
		if (d.weight == 1) {
			var tooltip_text = 'User 1: ' + d.source.display_name + '<br>' + 
				'User 2: ' + d.target.display_name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Message: ' + d.note + '<br>' + 
				'Transaction Start Date: ' + d.date_created + '<br>' + 
				'Transaction Completion Date: ' + d.date_completed + '<br>'
		} else {
			var tooltip_text = 'User 1: ' + d.source.display_name + '<br>' + 
				'User 2: ' + d.target.display_name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Message: Many' + '<br>'
		}

		link_tooltip
			.html(tooltip_text)
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 100) + "px")
			.style("color", "white")
	})
	.on("mouseleave", function(event, d) {
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
	});

//filter data by name/date and call network generation function
function filter(event){
	var filternodes = venmoData.nodes, filterlinks = venmoData.links;

	//get values
	var namevalue = document.getElementById("search").value === '' ? '.*' : document.getElementById("search").value;
	var startdatevalue = document.getElementById("startdate").value === '' ? "2010-01-01" : document.getElementById("startdate").value;
	var enddatevalue = document.getElementById("enddate").value === '' ? "2030-01-01" : document.getElementById("enddate").value;
	//var chargesvalue = document.getElementById("chargeorpay").value === 'all' ? '.*' : document.getElementById("chargeorpay").value;
	//console.log(namevalue);console.log(startdatevalue);console.log(enddatevalue);//console.log(chargesvalue);

	//filter links and nodes
	filterlinks = filterlinks.filter(function(d){
		reformatDate = d.date_created[0].slice(6,10)+"-"+d.date_created[0].slice(0,2) +"-"+d.date_created[0].slice(3,5);
		return (((d.source.display_name.search(namevalue) !== -1) || (d.target.display_name.search(namevalue) !== -1)) 
			&& (reformatDate >= startdatevalue)
			&& (reformatDate <= enddatevalue))
	});

	var allnames = []

	for (var i = 0; i < filterlinks.length; i++) {
		allnames.push(filterlinks[i].source.name);
		allnames.push(filterlinks[i].target.name);
	}

	filternodes = filternodes.filter(function(d){
		return allnames.includes(d.name)
	});

	//for debugging
	console.log(filterlinks);console.log(filternodes);

	//generate new network
	generateGraph(filternodes,filterlinks);
}



//create line graph over time
var lineW = "90vw";
var lineH = "60vh";
var networksvg = d3.select("#graphovertime")
	        .append("svg")
	        .attr("width", lineW)
	        .attr("height", lineH);

//create user graph
var userW = "45vw";
var userH = "45vh";
var networksvg = d3.select("#usergraph")
	        .append("svg")
	        .attr("width", userW)
	        .attr("height", userH);

//create emoji graph
var emojiW = "45vw";
var emojiH = "45vh";
var networksvg = d3.select("#emojigraph")
	        .append("svg")
	        .attr("width", emojiW)
	        .attr("height", emojiH);

}) //end of then function

</script>


<h2 id="design-choices">Design Choices and Reflection</h2>
<div>
<p>
Kiran Gite and Shane Weisberg, for MIT 6.859 Interactive Data Visualization, Spring 2021. <a href="https://github.com/6859-sp21/final-project-byo_venmo_transaction_network" target=" blank"> [Source code]</a>
</p>
</div>


</body>

</html>