<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="https://d3js.org/d3.v6.js"></script>

<style type="text/css">
svg {
	display: block;
	margin: auto;
}

body {
	font-size: 15px;
	font-family: Helvetica, sans-serif;
}

h1{
	color: #3d95ce;
}

.filtering{
	display: inline-block;
	padding: 10px;
	margin-right: 20px;
}

.biggraph{
	border-style: solid;
	border-width: 1px;
}

.smallgraph{
	border-style: solid;
	display: inline-block;
	border-width: 1px;
}


div.tooltip {
	position:absolute;
	text-align: left;
	width: auto;
	height: auto;
	padding: 3px;
	font: 14px sans-serif;
	font-weight: 300;
	border: 2px;
	border-radius: 0px;
	pointer-events: none;
	background-color: #3d95ce;
}

div.tooltip_img {
	position: absolute;
	text-align: center;
	width: 50px;
	height: 50px;
	padding: 0px;
	font: 14px sans-serif;
	font-weight: 900;
	border: 0px;
	border-radius: 0px;
	pointer-events: none;
}

#datesubmit{
	background-color:#3d95ce;
	margin-left: 20px;
	margin-right: 20px;
}

</style>

</head>

<body>

<h1>Build Your Own Venmo Network</h1>

<div id="searchfilter" class="filtering">
	<label for="search">Search by name:</label><input type="text" id="search">
</div>
<div id="msgfilter" class="filtering">
	<label for="search">Search messages:</label><input type="text" id="msg" size="10"><button>ðŸ˜€</button>
</div>
<div id="datefilter" class="filtering">
	<label for="startdate">Start date:</label><input type="date" id="startdate" value="2018-07-01" min="2018-07-01" max="2019-02-28">
	<label for="enddate">End date:</label><input type="date" id="enddate" value="2019-02-28" min="2018-07-01" max="2019-02-28">
	<input id="datesubmit" type="button" value="Filter">
	<input id="searchsubmit" type="button" value="Clear name searches">
</div>
<div id="chargefilter" class="filtering" style="display:none">
<label for="chargeorpay">Charges, payments, or both:</label>
<select id="chargeorpay">
  <option value="all">All</option>
  <option value="charges">Charges</option>
  <option value="payments">Payments</option>
</select>
</div>
<div id="showalldiv" class="filtering">
	<input id="showall" type="button" value="Show all">
</div>
<div id="begin" class="filtering">
	<input id="begin" type="button" value="begin">
</div>

<div id="namesearches">
</div>

<div id="nonodesfound" style="display: none;">No nodes found!</div>

<div id="networkvis" class="biggraph"></div>

<div style="margin:auto;text-align: center;">
<div id="graphoverdate" class="smallgraph"></div>

<div id="graphovertime" class="smallgraph"></div>
</div>

<div style="margin:auto;text-align: center;">
<div id="usergraph" class="smallgraph"></div>

<div id="emojigraph" class="smallgraph"></div>
</div>

<script>

Promise.all([
//d3.csv("placeholder.csv")
d3.json("https://raw.githubusercontent.com/6859-sp21/final-project-byo_venmo_transaction_network/main/venmo_gt4_first200k_full.json")
])
.then(function(dt){

venmoData = dt[0];
//console.log(venmoData.links);
//console.log(venmoData.nodes);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Some variables
var radius = 4,
	link_strength = 0.25,
	center_strength = 1,
	charge = -0.1,
	image_left = 100
	image_top = 100;

//create network
var networkW = "90vw";
var networkH = "80vh";
var networksvg = d3.select("#networkvis")
	        .append("svg")
			.attr("id", "networkvis_inner")
	        .attr("width", networkW)
	        .attr("height", networkH);


//zoom/pan functionality
var g = networksvg.append("g")
    .attr("class", "everything");

var zoom_handler = d3.zoom()
    .on("zoom", zoom_actions)
    .scaleExtent([1,8]);

zoom_handler(networksvg);  

function zoom_actions({transform}){
    g.attr("transform", transform);
}

// Tooltip for hovering over nodes
var node_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

// Tooltip for hovering over edges
var link_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip")
               .style("opacity", 0);

var img_tooltip = d3.select("body").append("div")
               .attr("class", "tooltip_img")
               .style("opacity", 0);

// linear scale for calculating edge width (may have to adjust the upper bound later)
var stroke_scale = d3.scaleLinear().domain([1,102]).range([5,10]);

//color scale: need to add legend at some point
var color_scale = d3.scaleDiverging(d3.interpolateInferno).domain([1,2,10]); //definitely adjust bounds for more data


var link = 0, node = 0;
/*var link = g
    		.selectAll("line")
			.data(venmoData.links)
			.join("line")
			.style("stroke", "#aaa")
			.style("stroke-width", function(d) {
				return stroke_scale(d.weight);
			});

// Initialize the nodes
var node = g
			.selectAll("circle")
			.data(venmoData.nodes)
			.join("circle")
			.attr("r", radius)
			.style("fill", function(d){return color_scale(d.neighbors.length)});


// Hovering functionality for the nodes and edges
node
	.on("mouseenter", function(event, d) {
		//console.log(d);
		// Show the tooltip with details
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		node_tooltip
			.html('Name: ' + d.display_name + '<br>' + 
			'Number of Transactions: ' + d.n_trans + '<br>' + 
			'Number of Neighbors (Degree Centrality): ' + d.neighbors.length + '<br>' + 
			'Eigenvalue Centrality?')
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 50) + "px")
			.style("color", "white")

		// Also show a tooltip with the image
		img_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		img_tooltip
			.html(' ')   
			.style("left", event.pageX + 10  + "px")
			.style("top", event.pageY + 30 + "px")
			.style("background-image", "url(" + d.photo_url + ")");
	})
	// And get rid of them when the mouse moves
	.on("mouseleave", function(event, d) {
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

		img_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

	})
	.on("click", function(event, d) {
		filter(d,"click");
	});



// Same for edges
link
	.on("mouseenter", function(event, d) {
		//console.log(d);
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 1);
		
		// Slightly different messages for edges with weight 1
		if (d.weight == 1) {
			var tooltip_text = 'User 1: ' + d.source.display_name + '<br>' + 
				'User 2: ' + d.target.display_name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Message: ' + d.note + '<br>' + 
				'Transaction Start Date: ' + d.date_created + '<br>' + 
				'Transaction Completion Date: ' + d.date_completed + '<br>'
		} else {
			var tooltip_text = 'User 1: ' + d.source.display_name + '<br>' + 
				'User 2: ' + d.target.display_name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Messages: ' + d.note + '<br>'
		}

		link_tooltip
			.html(tooltip_text)
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 100) + "px")
			.style("color", "white")
	})
	.on("mouseleave", function(event, d) {
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
	});*/

// There's probably a better way of locating the center of the network...
var width = networksvg.attr("width"),
	height = networksvg.attr("height"),
	wind_width = window.innerWidth,
	svg_width = d3.select('#networkvis_inner').attr('width').slice(0,2)/100,
	svg_width_px = wind_width * svg_width,
	wind_height = window.innerHeight,
	svg_height = d3.select('#networkvis_inner').attr('height').slice(0,2)/100,
	svg_height_px = wind_height * svg_height;

//var namevalue = [document.getElementById("search").value];
namevalue = ["ClaytonSilva", "Crew-Chiefs", "Matthew-Woodson-4", "blingq"];
//namevalue = [];
click_namevalue = [];
var simulation = 0;
//var begin = false;

document.getElementById("begin").addEventListener('click',
	function(event){
		start_sim();
		filter(event, type = "filter", start = true);
		
	});

function generateGraph(nodesdata,linksdata, start = false){
	//console.log(nodesdata); console.log(linksdata);

	node_tooltip.transition()
		.duration(100)
		.style("opacity", 0);

	img_tooltip.transition()
		.duration(100)
		.style("opacity", 0);

	//update link and node with new data
	link = g
    		.selectAll("line")
			.data(linksdata)
			.join("line")
			.style("stroke", "#aaa")
			.style("stroke-width", function(d) {
				return stroke_scale(d.weight);
			});

	/*link = link.data(linksdata)
		.join("line")
		.style("stroke", "#aaa")
		.style("stroke-width", function(d) {
			return stroke_scale(d.weight);
		})*/

	node = g
		.selectAll("circle")
		.data(nodesdata)
		.join("circle")
		.attr("r", radius)
		.style("fill", function(d){return color_scale(d.neighbors.length)});

	/*node = node.data(nodesdata)
		.join("circle")
		.attr("r", radius)
		.style("fill", function(d){return color_scale(d.neighbors.length)});*/
	
	// Had to paste the same mouse listeners in here. Probably a smarter way...
	node
	.on("mouseenter", function(event, d) {
		// Show the tooltip with details
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0.9);

		node_tooltip
			.html('Username: ' + d.name + '<br>' + 
			'Number of Transactions: ' + d.n_trans + '<br>' + 
			'Number of Neighbors (Degree Centrality): ' + d.neighbors.length + '<br>')
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 50) + "px")
			.style("color", "white")

		img_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		img_tooltip
			.html(' ')   
			.style("left", event.pageX + 10  + "px")
			.style("top", event.pageY + 30 + "px")
			.style("background-image", "url(" + d.photo_url + ")");
	})
	.on("mouseleave", function(event, d) {
		node_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

		img_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

	})
	.on("click", function(event, d) {
		filter(d, "click");
	});

	// Same for edges
	link
	.on("mouseenter", function(event, d) {
		//console.log(d);
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0.9);
		
		// Slightly different messages for edges with weight 1
		if (d.weight == 1) {
			var tooltip_text = 'User 1: ' + d.source.name + '<br>' + 
				'User 2: ' + d.target.name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Message: ' + d.note + '<br>' + 
				'Transaction Start Date: ' + d.date_created + '<br>' + 
				'Transaction Completion Date: ' + d.date_completed + '<br>'
		} else {
			var tooltip_text = 'User 1: ' + d.source.name + '<br>' + 
				'User 2: ' + d.target.name + '<br>' + 
				'Number of Transactions: ' + d.weight + '<br>' + 
				'Messages: ' + d.note  + '<br>'
		}

		link_tooltip
			.html(tooltip_text)
			.style("left", (event.pageX + 10) + "px")
			.style("top", (event.pageY - 100) + "px")
			.style("color", "white")
	})
	.on("mouseleave", function(event, d) {
		link_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
	});

	//restart simulation
	if (!start) {
		simulation.nodes(nodesdata);
		simulation.force("link").links(linksdata);
		simulation.force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))  
		simulation.alpha(0.01).restart();


		//line graphs
		linegraphs(linksdata);
		userbargraph(nodesdata);
		emojibargraph(linksdata);
	}

}

//add functions to filter buttons
document.getElementById("searchsubmit").addEventListener('click',
	function(event){document.getElementById("search").value = '';namevalue=[];document.getElementById("namesearches").innerHTML="";filter(event);});
document.getElementById("datesubmit").addEventListener('click',filter);
//document.getElementById("chargefilter").addEventListener('change',filter);
document.getElementById("showall").addEventListener('click',
	function(){
		document.getElementById("search").value = '';document.getElementById("namesearches").innerHTML="";
		document.getElementById("msg").value="";
		document.getElementById("startdate").value="2018-07-01";document.getElementById("enddate").value="2019-02-28";
		namevalue=[];
		click_namevalue=[];
		generateGraph(venmoData.nodes,venmoData.links);
	});




/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//filter data by name/date and call network generation function
// Added functionality for filter by clicking: change type = "click"
function filter(event, type = "filter", start = false){
	var filternodes = venmoData.nodes, filterlinks = venmoData.links;

	// namevalue is now a global variable set in line (approximately 197)
	// Also it's a list now, so using the filter bar adds to this list
	if (!namevalue.includes(document.getElementById("search").value) && (document.getElementById("search").value !== '') ) {
		namevalue.push(document.getElementById("search").value);
		document.getElementById("namesearches").innerHTML = document.getElementById("namesearches").innerHTML +document.getElementById("search").value+"; ";
	};
	

	// Similarly, there's a second global list that keeps track of nodes that have been clicked on and their neighbors
	// If we're using this function on a click, add the clicked node to add to the list of clicked nodes
	if ((type == "click") && (!click_namevalue.includes(event.name))) {
		click_namevalue.push(event.name);
	}

	//console.log(namevalue,click_namevalue);

	var startdatevalue = document.getElementById("startdate").value === '' ? "2010-01-01" : document.getElementById("startdate").value;
	var enddatevalue = document.getElementById("enddate").value === '' ? "2030-01-01" : document.getElementById("enddate").value;
	//var chargesvalue = document.getElementById("chargeorpay").value === 'all' ? '.*' : document.getElementById("chargeorpay").value;
	//console.log(namevalue);console.log(startdatevalue);console.log(enddatevalue);//console.log(chargesvalue);
	var msgvalue = document.getElementById("msg").value === '' ? /.*/ : document.getElementById("msg").value;


	//filter links and nodes
	filterlinks = filterlinks.filter(function(d){
		//console.log(d);
		reformatDate = d.date_created[0].slice(6,10)+"-"+d.date_created[0].slice(0,2) +"-"+d.date_created[0].slice(3,5);

		var searchcontains=false;

		//handle case sensitivity? maybe later
		for (var i = 0; i < namevalue.length; i++) {
			if ((d.source.name.includes(namevalue[i])) || (d.target.name.includes(namevalue[i]))) {
				searchcontains = true;
			}
		}

		var notes = d.note.join()
		//return (((d.source.display_name.search(namevalue) !== -1) || (d.target.display_name.search(namevalue) !== -1)) 
		//	&& (reformatDate >= startdatevalue)
		//	&& (reformatDate <= enddatevalue))
		return ( ( (namevalue.length==0 && click_namevalue.length==0 && document.getElementById("msg").value==='')
			|| searchcontains || (namevalue.includes(d.source.name)) || (namevalue.includes(d.target.name)) 
			|| (click_namevalue.includes(d.source.name)) || (click_namevalue.includes(d.target.name))  )
			&& (reformatDate >= startdatevalue)
			&& (reformatDate <= enddatevalue)
			|| (notes.search(msgvalue) > 0))
	});

	var allnames = []

	for (var i = 0; i < filterlinks.length; i++) {
		allnames.push(filterlinks[i].source.name);
		allnames.push(filterlinks[i].target.name);
	}

	filternodes = filternodes.filter(function(d){
		return allnames.includes(d.name)
	});

	//for debugging
	//console.log(filterlinks);console.log(filternodes);

	//generate new network
	generateGraph(filternodes,filterlinks,start);
	d3.selectAll("circle").raise(); // circles on top of the lines

	//simulation.nodes(filternodes);
	//simulation.force("link").links(filterlinks);
	if (!start) {
		simulation.force("charge", d3.forceManyBody().strength(charge*10));
		simulation.force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength)); 
		simulation.alpha(1).restart();
	}


	//return simulation;
}

function start_sim() {
simulation = d3.forceSimulation(venmoData.nodes)              // Force algorithm is nodes
      .force("link", d3.forceLink(venmoData.links).strength(link_strength)                // This force provides links between nodes
            .id(function(d) { return d.id; })                     
      )
      //.force("charge", d3.forceManyBody().strength(charge))         // Repulsion between nodes.
      .force("center", d3.forceCenter(svg_width_px / 2, svg_height_px / 2).strength(center_strength))     // Attracts nodes to the center of the svg area
	  //.force("x", d3.forceX()) // Can mess around with these
      //.force("y", d3.forceY())
	  //.stop()
	  .on("tick", ticked);


 // This function is run at each iteration of the force algorithm, updating the nodes position.
 function ticked() {
	node
         .attr("cx", function (d) { return d.x = Math.max(radius,Math.min(svg_width_px - radius, d.x)); })
         .attr("cy", function(d) { return d.y = Math.max(radius,Math.min(svg_height_px - radius, d.y)); });
    link
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y;})
        .attr("x2", function(d) { return d.target.x;})
        .attr("y2", function(d) { return d.target.y;}); 
  }

}


/////////////////////////////////////////////////////////////////////////////////////////////////////////////
//create line graph over days

function linegraphs(linksdata){

d3.select("#datesvg").remove();
d3.select("#timesvg").remove();

var lineW = window.innerWidth*0.45;
var lineH = window.innerHeight*0.6;
var margin = 20;
var linegraphsvg = d3.select("#graphoverdate")
	        .append("svg")
	        .attr("width", 2*margin + lineW)
	        .attr("height", 2*margin + lineH)
	        .attr("id","datesvg");


linegraphtmp = {};

mdy_formatter = d3.timeParse("%m/%d/%Y");

for (var i = 0; i < linksdata.length; i++) {
	for (var j = 0; j < (linksdata)[i].date_created.length; j++) {
		mydate = ((linksdata)[i].date_created)[j].slice(0,10);
		datekey = mdy_formatter(mydate);
		if (datekey in linegraphtmp){
			linegraphtmp[datekey] += 1; 
		} else{
			linegraphtmp[datekey] = 1;
		}
	}
}

linegraphData = [];

for (const key of Object.keys(linegraphtmp)) {
	linegraphData.push({"date":key,"value":linegraphtmp[key]});
}

//console.log(linegraphData);

var x = d3.scaleTime()
      .domain(d3.extent(linegraphData, function(d) { return new Date(d.date); }))
      .range([2*margin, lineW]);

linegraphsvg.append("g")
	.attr("transform", "translate("+0+"," + lineH + ")")
	.call(d3.axisBottom(x));

var y = d3.scaleLinear()
  	.domain([0, d3.max(linegraphData, function(d) { return +d.value; })])
  	.range([ lineH, margin]);


//console.log(typeof linegraphData[0].date,x(linegraphData[0].date),y(linegraphData[0].value));

linegraphsvg.append("g")
	.attr("transform", "translate("+2*margin+",0)")
  	.call(d3.axisLeft(y).tickSize(0));

linegraphsvg.append("path")
  	.datum(linegraphData)
  	.attr("fill", "none")
  	.attr("stroke", "orange")
  	.attr("stroke-width", 1.5)
  	.attr("d", d3.line()
    	.x(function(d) { return x(new Date(d.date)) })
    	.y(function(d) { return y(d.value) }) );

//console.log(linegraphData);

linegraphsvg.append("circle")
  	.data(linegraphData)
  	.join("circle")
  	.attr("fill", "orange")
  	.attr("r",3)
  	.attr("cx",function(d) { return x(new Date(d.date)) })
   	.attr("cy",function(d) { return y(d.value) });

///////////////////////////////////////////////////////////////////////////////////
//create line graph over time

var timegraphsvg = d3.select("#graphovertime")
	        .append("svg")
	        .attr("width", 2*margin + lineW)
	        .attr("height", 2*margin + lineH)
	        .attr("id","timesvg");


timegraphtmp = {};

//hms_formatter = d3.timeParse("%H:%M:%S");

for (var i = 0; i < linksdata.length; i++) {
	for (var j = 0; j < (linksdata)[i].date_created.length; j++) {
		timekey = +((linksdata)[i].date_created)[j].slice(12,14);
		if (timekey in timegraphtmp){
			timegraphtmp[timekey] += 1; 
		} else{
			timegraphtmp[timekey] = 1;
		}
	}
}

timegraphData = [];

for (const key of Object.keys(timegraphtmp)) {
	timegraphData.push({"time":key,"value":timegraphtmp[key]});
}


//console.log(timegraphData);
//console.log(new Date("01/01/1900 00:00:00"));

var timex = d3.scaleLinear()
      .domain([0,24])
      .range([2*margin, lineW]);

timegraphsvg.append("g")
	.attr("transform", "translate("+0+"," + lineH + ")")
	.call(d3.axisBottom(timex).tickFormat(x => x+":00"));

var timey = d3.scaleLinear()
  	.domain([0, d3.max(timegraphData, function(d) { return +d.value; })])
  	.range([ lineH, margin]);


//console.log(typeof linegraphData[0].date,x(linegraphData[0].date),y(linegraphData[0].value));

timegraphsvg.append("g")
	.attr("transform", "translate("+2*margin+",0)")
  	.call(d3.axisLeft(timey).tickSize(0));

timegraphsvg.append("path")
  	.datum(timegraphData)
  	.attr("fill", "none")
  	.attr("stroke", "orange")
  	.attr("stroke-width", 1.5)
  	.attr("d", d3.line()
    	.x(function(d) { return timex(+d.time) })
    	.y(function(d) { return timey(d.value) }) );

timegraphsvg.append("circle")
  	.data(timegraphData)
  	.join("circle")
  	.attr("fill", "orange")
  	.attr("r",3)
  	.attr("cx",function(d) { return timex(+d.time) })
   	.attr("cy",function(d) { return timey(d.value) });

} // function end




linegraphs(venmoData.links);

//////////////////////////////////////////////////////////////////////////////////////////////////////

// Function to make a bar graph showing the most active users (number of transactions) in the time span
function userbargraph(nodesdata){

	d3.select("#usersvg").remove();

	var userW = window.innerWidth*0.45;
	var userH = window.innerHeight*0.6;
	var margin = 20;
	var n_bars = 40;
	var usersvg = d3.select("#usergraph")
				.append("svg")
				.attr("width", 2*margin + userW)
				.attr("height", 2*margin + userH)
				.attr("id","usersvg");

	// calculate bar width
	var bar_width = (userW) / n_bars;
	

	// Sort the nodes by decreasing number of transactions (and take the first n)
	sortedNodes = nodesdata.slice().sort((a, b) => d3.descending(a.n_trans, b.n_trans)).slice(0,n_bars);

	// Construct the y scale based on the largest number of transactions
	var max_trans = sortedNodes[0].n_trans;
	var barscale = d3.scaleLinear().domain([1,max_trans]).range([userH,5]);
	var xscale = d3.scaleBand().range([0,userW + margin]);
	//console.log(sortedNodes);

	// Draw some bars
	var bars = usersvg.selectAll("g").data(sortedNodes) // attatch to the data
			.enter().append("g")
			// Make some rectangles (https://www.youtube.com/watch?v=lW3I7yz5nVo)
			.attr("transform", function(d, i) {
				return "translate(" + (Number(margin) + (i * bar_width)) + "," + barscale(Number(d.n_trans)) + ")";
			})
			.append("rect").attr("height", function(d) {
				return (userH - barscale(Number(d.n_trans)));
			})
			.attr("width",bar_width)
			.attr("fill", "lightsteelblue")
			.attr('stroke','white');

	d3.select('#usersvg').append("text").attr("x",userW/3).attr('y',userH+15).text("Users - hover over bars to see details");
	
	// X axis
	usersvg.append('g')
		.attr('class','xaxis')
		.attr('transform', 'translate(' + (margin / 2) + ',' + userH + ')')
		.call(d3.axisBottom(xscale).tickSize(0));
	
	// Y axis
	usersvg.append('g')
		.attr('class','yaxis')
		.attr('transform','translate(' + margin / 2 + ',' + 0 + ')')
		.call(d3.axisLeft(barscale).ticks(5).tickSize(0));
		/*.append('text')
			.attr('transform','translate(-130,40) rotate(-90)')
			.attr('text-anchor', 'end')
			.attr('fill', 'black')
			.attr('font-size', '12px')
			.attr('font-weight', 'bold')
			.attr('x', 0)
			.attr('y', 100)
			.text('Number of Transactions');*/
	
	// Bars get a tooltip too!
	var bar_tooltip = d3.select("#usergraph").append("div")
		.attr("class", "tooltip")
		.attr('id', 'bar_tooltip')
		.style("opacity", 0)
		.style("top", -2 * margin + "px");
	
	// bars turn to black on hover and show the tooltip
	bars
	.on("mouseover", function(event, d) {
		d3.select(this).transition()
			.duration(100)
			.style("fill", "black");
		
		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		bar_tooltip
			.html('Username: ' + d.name + '<br>' + 
			'Number of Transactions: ' + d.n_trans + '<br>' + 
			'Number of Neighbors (Degree Centrality): ' + d.neighbors.length)
			.style("left", (event.pageX ) +60+ "px")
			.style("top", (event.pageY - 80) + "px")
			.style("color", "white")
		
	})
	.on("mouseout", function(event, d) {
		d3.select(this).transition()
			.duration(100)
			.style("fill", "lightsteelblue");

		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 0);

	});


};

// Call the function
userbargraph(venmoData.nodes);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Function to make a bar graph showing the most used emojis in the time span
function emojibargraph(linksdata){
	d3.select("#emojisvg").remove();

	var emojiW = window.innerWidth*0.45;
	var emojiH = window.innerHeight*0.6;
	var margin = 20;
	var n_bars = 20;
	var emojisvg = d3.select("#emojigraph")
				.append("svg")
				.attr("width", 2*margin + emojiW)
				.attr("height", 2*margin + emojiH)
				.attr("id","emojisvg");

	// calculate bar width
	var bar_width = (emojiW) / n_bars;

	// Get ready for some emoji math
	emojicounts = {}; // cumulative counts

	// a function that returns true for (most) emojis
	const regexExp = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/gi;

	// loop through all links
	for (var i = 0; i < linksdata.length; i++) {
		notes = linksdata[i].note; // pull out the notes
		for (var j = 0; j < notes.length; j++) { // some of the links have multiple notes, so loop through each one
			if(regexExp.test(notes[j])) { // test the note for emojis
				note_array = Array.from(notes[j]); // If so, split it into character / emoji chunks
				for (let characters of note_array) { // Loop through these chunks
					if (regexExp.test(characters)) { // If it's an emoji add it to the dictionary
						if (characters in emojicounts) {
							emojicounts[characters]++
						} else {
							emojicounts[characters] = 1
						}
					}
				}
			}
		}
	};
	// woof

	// Now we have to turn that dict into a list of smaller dicts because thats the only way I know how to sort
	emojicounts_list = [];
	for (const [key, value] of Object.entries(emojicounts)) {
		if ((key!=="â€™") && (key!=="")) {
			emojicounts_list.push({"emoji":key, "count": value});
		}
	};

	if (emojicounts_list.length == 0){
		d3.select("#emojisvg").append("text").text("No emojis used!").attr("x",emojiW/2).attr("y",emojiH/2);
		return -1;
	}


	// sort, as promised
	sorted_emojis = emojicounts_list.slice().sort((a, b) => d3.descending(a.count, b.count)).slice(0,n_bars);
	//console.log((sorted_emojis[17].emoji === ''));

	// The rest is just making a bar graph
	// Construct the y scale based on the largest number of transactions
	var max_count = sorted_emojis[0].count;
	var barscale = d3.scaleLinear().domain([0.5,max_count]).range([emojiH,5]);
	var xscale = d3.scaleBand().domain(sorted_emojis.map(d => d.emoji)).range([0,emojiW]);

	// Draw some bars
	var bars =emojisvg.selectAll("g").data(sorted_emojis) // attatch to the data
			.enter().append("g")
			// Make some rectangles (https://www.youtube.com/watch?v=lW3I7yz5nVo)
			.attr("transform", function(d, i) {
				return "translate(" + (xscale(d.emoji)+margin+xscale.bandwidth()/2-bar_width/2) + "," + barscale(Number(d.count)) + ")";
			})
			.append("rect").attr("height", function(d) {
				return (emojiH - barscale(Number(d.count)));
			})
			.attr("width",bar_width)
			.attr("fill", "lightsteelblue")
			.attr('stroke','white');
	
	// X axis
	emojisvg.append('g')
		.attr('class','xaxis')
		.attr('transform', 'translate(' + (margin) + ',' + emojiH + ')')
		.style('font-size','20px')
		.call(d3.axisBottom(xscale).tickSize(0));
	
	// Y axis
	emojisvg.append('g')
		.attr('class','yaxis')
		.attr('transform','translate(' + (margin) + ',' + 0 + ')')
		.call(d3.axisLeft(barscale).ticks(5).tickSize(0));
		/*.append('text')
			.attr('transform','translate(-130,40) rotate(-90)')
			.attr('text-anchor', 'end')
			.attr('fill', 'black')
			.attr('font-size', '12px')
			.attr('font-weight', 'bold')
			.attr('x', 0)
			.attr('y', 100)
			.text('Number of Transactions');*/

	// Bars get a tooltip too!
	var bar_tooltip = d3.select("#emojigraph").append("div")
		.attr("class", "tooltip")
		.attr('id', 'bar_tooltip_e')
		.style("opacity", 0)
		.style("top", -2 * margin + "px");
	
	// bars turn to black on hover and show the tooltip
	bars
	.on("mouseover", function(event, d) {
		d3.select(this).transition()
			.duration(100)
			.style("fill", "black");
		
		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 1);

		bar_tooltip
			.html('Emoji: ' + d.emoji + '<br>' + 
			'Number of Uses: ' + d.count)
			.style("left", (event.pageX - 125) + "px")
			.style("top", (event.pageY - 80) + "px")
			.style("color", "white");		
	})
	.on("mouseout", function(event, d) {
		d3.select(this).transition()
			.duration(100)
			.style("fill", "lightsteelblue");

		bar_tooltip.transition()
			.duration(100)
			.style("opacity", 0);
	});

};
emojibargraph(venmoData.links);

//create emoji graph
/*var emojiW = "45vw";
var emojiH = "45vh";
var emojisvg = d3.select("#emojigraph")
	        .append("svg")
	        .attr("width", emojiW)
	        .attr("height", emojiH);*/
}); //end of then function

</script>

<!--- emoji menu --->
<script src="fgEmojiPicker.js"></script>
    <script>
        const emojiPicker = new FgEmojiPicker({
            trigger: 'button',
            removeOnSelection: false,
            closeButton: true,
            position: ['bottom', 'right'],
            preFetch: true,
            insertInto: document.getElementById('msg'),
            emit(obj, triggerElement) {
                console.log(obj, triggerElement);
            }
        });
    </script>


<h2 id="design-choices">Design Choices and Reflection</h2>
<div>
<p>
Kiran Gite and Shane Weisberg, for MIT 6.859 Interactive Data Visualization, Spring 2021. <a href="https://github.com/6859-sp21/final-project-byo_venmo_transaction_network" target=" blank"> [Source code]</a>
</p>
</div>


</body>

</html>